Ext.require(["Ext.data.validations"],function(){var a=function(b,d){if(!b){return true}if(!Ext.isDefined(d)){return true}var c=b.split(".").pop();return Ext.Array.contains(d,c)};Ext.apply(Ext.data.validations,{numberformatMessage:"is not a number or not in the allowed range",fileMessage:"is not a valid file",numberformat:function(b,c){if(typeof c!=="number"){c=(b.precision===0)?parseInt(c,10):parseFloat(c);if(typeof c!=="number"){return false}}if((Ext.isDefined(b.min)&&b.min>c)||(Ext.isDefined(b.max)&&c>b.max)){return false}return true},file:function(b,c){return a(c,b.extension)}})});
/*!
 *
 * Bancha Scaffolding Library
 * Copyright 2011-2012 Roland Schuetz
 *
 * Licensed under The MIT License
 * Redistributions of files must retain the above copyright notice.
 *
 * @package       Bancha.scaffold
 * @copyright     Copyright 2011-2012 Roland Schuetz
 * @link          http://scaffold.banchaproject.org
 * @since         Bancha.scaffold 0.2.5
 * @license       MIT License (http://www.opensource.org/licenses/mit-license.php)
 * @author        Roland Schuetz <mail@rolandschuetz.at>
 * @version       Bancha.scaffold v 0.5.7
 *
 * For more information go to http://scaffold.banchaproject.org
 */
Ext.require(["Ext.form.field.VTypes"],function(){var a=function(b,d){if(!b){return true}if(!Ext.isDefined(d)){return true}var c=b.split(".").pop();return Ext.Array.contains(d,c)};Ext.apply(Ext.form.field.VTypes,{fileExtension:function(c,b){return a(c,b.validExtensions)},fileExtensionText:"This file type is not allowed.",fileExtensionMask:/[\^\r\n]/})});Ext.define("Bancha.scaffold",{singleton:true,requires:["Ext.form.field.VTypes","Ext.data.validations"],Util:{toFirstUpper:function(a){if(typeof a!=="string"){return a}if(a.length===1){return a.toUpperCase()}return a[0].toUpperCase()+a.substr(1)},humanize:function(a){a=a.replace(/_id/g,"");a=a.replace(/_/g," ");a=a.replace(/([a-z])([A-Z])/g,function(c,d,b){return d+" "+b.toLowerCase()});return this.toFirstUpper(a)},humanizeClassName:function(a){if(a.indexOf(".")){a=a.substr(a.lastIndexOf(".")+1)}return this.humanize(a)},toTitle:function(a){return a.replace(/ ([a-z])/g,function(b,c){return" "+c.toUpperCase()})},createFacade:function(a,b,c){return function(){return b[c].apply(b,arguments)}},replaceButtonPlaceHolders:function(d,b,e){if(typeof d==="undefined"||d.length===0){return d}for(var c=0,a=d.length;c<a;c++){switch(d[c]){case"create":d[c]=Ext.apply(b.createButtonConfig,{scope:e,handler:b.onCreate});break;case"reset":d[c]=Ext.apply(b.resetButtonConfig,{scope:e,handler:b.onReset});break;case"save":d[c]=Ext.apply(b.saveButtonConfig,{scope:e,handler:b.onSave});break;default:if(d[c].scope==="scaffold-scope-me"){d[c].scope=e}}}return d},getStore:(function(c,b){var a={};return function(g,f){var d=Ext.ClassManager.getName(g),e;if(f.oneStorePerModel&&a[d]){return a[d]}e=Ext.create(f.storeDefaultClass||"Ext.data.Store",Ext.apply({model:d},Ext.clone(f.storeDefaults)));if(f.oneStorePerModel){a[d]=e}return e}}()),getDisplayFieldName:function(a){if(Ext.isString(a.displayField)){return a.displayField}var b=Ext.Array.pluck(a.getFields(),"name");if(b.indexOf("name")!==-1){return"name"}if(b.indexOf("title")!==-1){return"title"}if(b.indexOf("code")!==-1){return"code"}return a.idProperty||b[0]},fieldNameToModelAssociationName:function(a){if(!Ext.isString(a)){return}var c=a.split("_");if(c.length<2||c[c.length-1]!=="id"){return}c.pop();var b=c.shift();Ext.each(c,function(d){b+=d.substr(0,1).toUpperCase()+d.substr(1)});return b+"s"},getBelongsToAssociation:function(e,c){var a=this.fieldNameToModelAssociationName(e.name),d=Ext.isFunction(c.getAssociations)?c.getAssociations():(c.prototype?c.prototype.associations:false),b=(a&&d)?d.get(a):false;return b}},Grid:{createFacade:function(a){return Bancha.scaffold.Util.createFacade("Grid",this,a)},fieldToColumnConfigs:{auto:{xtype:"gridcolumn"},string:{xtype:"gridcolumn"},"int":{xtype:"numbercolumn",format:"0"},"float":{xtype:"numbercolumn"},"boolean":{xtype:"booleancolumn"},bool:{xtype:"booleancolumn"},date:{xtype:"datecolumn"}},exclude:[],columnDefaults:{flex:1},gridcolumnDefaults:{},numbercolumnDefaults:{},booleancolumnDefaults:{},datecolumnDefaults:{},formConfig:{},storeDefaultClass:"Ext.data.Store",storeDefaults:{autoLoad:true},oneStorePerModel:true,transformColumnConfig:function(a,b){return a},internalTransformColumnConfig:function(a,b){if(a.dataIndex==="id"){a.hidden=true;a.field=undefined}return a},buildDefaultColumnFromModelType:function(c,d){d=d||{};var b=this.fieldToColumnConfigs[c],a=Ext.clone(d.columnDefaults||this.columnDefaults),e=d[b.xtype+"Defaults"]||this[b.xtype+"Defaults"];return Ext.apply(a,b,e)},buildColumnConfig:function(h,f,c,d,a){var g=h.type.type,e=this.buildDefaultColumnFromModelType(g,c),j,b,i,k;if(h.name){e.text=Bancha.scaffold.Util.humanize(h.name);e.dataIndex=h.name}b=Bancha.scaffold.Util.getBelongsToAssociation(h,f);if(b){i=Bancha.scaffold.Util.getStore(b.associatedModel,c);k=Bancha.scaffold.Util.getDisplayFieldName(b.associatedModel);e.renderer=function(m){var l=i.getById(m);return l?l.get(k):(Bancha.t?Bancha.t("Unknown"):"Unknown")};a.render=Ext.Function.createSequence(a.render||Ext.emptyFn,function(l){if(i.getCount()===0){i.on("load",function(n,m,p,o){if(p){l.getView().refresh()}})}})}if(c.editable){j=c.formConfig||{};j=Ext.apply({},j,Ext.clone(Bancha.scaffold.Form));j.storeDefaults=c.storeDefaults;j.oneStorePerModel=c.oneStorePerModel;e.field=Bancha.scaffold.Form.buildFieldConfig(h,f,j,d,true);e.field=j.internalTransformFieldConfig(e.field,g);if(typeof j.transformFieldConfig==="function"){e.field=j.transformFieldConfig(e.field,g)}}e=c.internalTransformColumnConfig(e,g);if(typeof c.transformColumnConfig==="function"){e=c.transformColumnConfig(e,g)}return e},onCreate:function(){var e=this.getCellEditing(),c=e.grid,a=this.getStore(),b=a.getProxy().getModel(),f,d=false;e.cancelEdit();f=Ext.create(Ext.ClassManager.getName(b),{});a.insert(0,f);Ext.each(c.columns,function(h,g){if(h.hidden!==true){d=g;return false}});if(d){e.startEditByPosition({row:0,column:d})}},onSave:function(){var c=true,d="",b,a=this.getStore();a.each(function(e){if(!e.isValid()){c=false;b=e.get("name")||e.get("title")||(e.phantom?"New entry":e.getId());d+="<br><br><b>"+b+":</b>";e.validate().each(function(f){d+="<br>&nbsp;&nbsp;&nbsp;"+f.field+" "+f.message})}});if(!c){Ext.MessageBox.show({title:"Invalid Data",msg:'<div style="text-align:left; padding-left:50px;">There are errors in your data:'+d+"</div>",icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}else{a.sync()}},onReset:function(){var a=this.getStore();a.each(function(b){if(b&&b.modified){b.reject()}if(b&&b.phantom){a.remove(b)}});a.each(function(b){if(b&&b.modified){b.reject()}if(b&&b.phantom){a.remove(b)}})},onDelete:function(e,g,d){var b=e.getStore(),f=b.getAt(g),c=Ext.getClassName(f),a=Bancha.scaffold.Util.humanizeClassName(c);b.remove(f);b.sync({success:function(h,i){Ext.MessageBox.show({title:a+" record deleted",msg:a+" record was successfully deleted.",icon:Ext.MessageBox.INFO,buttons:Ext.Msg.OK})},failure:function(h,i){b.add(f);Ext.MessageBox.show({title:a+" record could not be deleted",msg:i.getError()||(a+" record could not be deleted."),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK})}})},editable:true,deletable:true,buttons:["->","create","reset","save"],createButtonConfig:{iconCls:"icon-add",text:"Create"},saveButtonConfig:{iconCls:"icon-save",text:"Save"},resetButtonConfig:{iconCls:"icon-reset",text:"Reset"},destroyButtonConfig:{xtype:"actioncolumn",width:50,items:[{icon:"/img/icons/delete.png",tooltip:"Delete",handler:Ext.emptyFn}]},buildColumns:function(b,a,f){var e=[],d,c;a=Ext.apply({},a,Ext.clone(this));if(Ext.isString(b)){b=Ext.ModelManager.getModel(b)}if(!Ext.isArray(a.exclude)){a.exclude=[]}d=b.prototype.validations;b.prototype.fields.each(function(g){if(a.exclude.indexOf(g.name)===-1){e.push(Bancha.scaffold.Grid.buildColumnConfig(g,b,a,d,f))}});if(a.deletable){c=Ext.clone(a.destroyButtonConfig);if(c.items[0].handler===Ext.emptyFn){c.items[0].handler=a.onDelete}e.push(c)}return e},beforeBuild:function(c,b,a){},afterBuild:function(d,c,b,a){},buildConfig:function(d,a,k){var b,e,h,c,g,i,j,f;a=Ext.apply({},a,Ext.clone(this));if(Ext.isString(d)){e=d;d=Ext.ClassManager.get(e)}else{e=Ext.getClassName(d)}a.target=e;b=a.beforeBuild(d,a,k)||{};i=Bancha.scaffold.Util.getStore(d,a);f={};Ext.apply(b,{store:i,columns:this.buildColumns(d,a,f),listeners:f});if(a.editable){g=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:2});Ext.apply(b,{selType:"cellmodel",plugins:[g]})}if(a.buttons&&a.buttons.length){j={getCellEditing:function(){return g},getStore:function(){return i}};a.buttons=Bancha.scaffold.Util.replaceButtonPlaceHolders(a.buttons,a,j);b.dockedItems=[{xtype:"toolbar",dock:"bottom",ui:"footer",items:a.buttons}]}if(Ext.isObject(k)){b=Ext.apply(b,k)}b.scaffold=a;return a.afterBuild(b,d,a,k)||b}},Form:{fieldToFieldConfigs:{auto:{xtype:"textfield"},string:{xtype:"textfield"},"int":{xtype:"numberfield",allowDecimals:false},"float":{xtype:"numberfield"},"boolean":{xtype:"checkboxfield"},bool:{xtype:"checkboxfield"},date:{xtype:"datefield"}},exclude:[],fieldDefaults:{},datefieldDefaults:{},fileuploadfieldDefaults:{emptyText:"Select an file"},textfieldDefaults:{},numberfieldDefaults:{},checkboxfieldDefaults:{uncheckedValue:false},transformFieldConfig:function(b,a){return b},internalTransformFieldConfig:function(b,a){if(b.name==="id"){b.xtype="hiddenfield"}return b},addValidationRuleConfigs:(function(){var c=/^[a-zA-Z_]+$/.toString(),d=/^[a-zA-Z0-9_]+$/.toString(),b=/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.toString(),a=/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.toString();return function(i,h,g){var f=i.name,e;Ext.Array.forEach(h,function(j){if(j.name!==f){return}switch(j.type){case"presence":i.allowBlank=false;break;case"length":if(i.xtype==="textfield"){if(Ext.isDefined(j.min)){i.minLength=j.min}if(Ext.isDefined(j.max)){i.maxLength=j.max}}break;case"format":switch(j.matcher.toString()){case c:i.vtype="alpha";break;case d:i.vtype="alphanum";break;case b:i.vtype="email";break;case a:i.vtype="url";break;default:break}break;case"numberformat":if(i.xtype==="numberfield"){if(Ext.isDefined(j.min)){i.minValue=j.min}if(Ext.isDefined(j.max)){i.maxValue=j.max}if(Ext.isDefined(j.precision)){i.decimalPrecision=j.precision}}break;case"file":i.xtype="fileuploadfield";Ext.apply(i,g.fileuploadfieldDefaults);if(Ext.isString(j.extension)){j.extension=[j.extension]}if(Ext.isArray(j.extension)){i.vtype="fileExtension";i.validExtensions=j.extension}break;default:break}});return i}}()),buildDefaultFieldFromModelType:function(b,d){d=d||{};var c=Ext.clone(this.fieldToFieldConfigs[b]),e=Ext.clone(d.fieldDefaults||this.fieldDefaults),a=Ext.clone(d[c.xtype+"Defaults"]||this[c.xtype+"Defaults"]);return Ext.apply(e,c,a)},buildFieldConfig:function(a,e,b,d,h){var f=a.type.type,g=this.buildDefaultFieldFromModelType(f,b),c,i,j;g.name=a.name;if(!h){g.fieldLabel=Bancha.scaffold.Util.humanize(a.name)}if(f==="date"&&!h&&a.dateFormat){g.format=a.dateFormat}if(Ext.isDefined(d)&&d.length){g=this.addValidationRuleConfigs(g,d,b)}c=Bancha.scaffold.Util.getBelongsToAssociation(g,e);if(c){Ext.apply(g,{xtype:"combobox",store:Bancha.scaffold.Util.getStore(c.associatedModel,b),displayField:Bancha.scaffold.Util.getDisplayFieldName(c.associatedModel),valueField:c.associatedModel.prototype.idProperty||"id",queryMode:"local"})}g=b.internalTransformFieldConfig(g,f);if(typeof b.transformFieldConfig==="function"){g=b.transformFieldConfig(g,f)}if(h&&g.xtype==="fileuploadfield"){g=undefined}return g},onSave:function(){var a=this.getForm(),b;if(a.isValid()){b=a.hasUpload()?"Uploading files...":"Saving data..";a.submit({waitMsg:b,success:function(c,d){Ext.MessageBox.alert("Success",d.result.msg||"Successfully saved data.")},failure:function(c,d){Ext.MessageBox.alert("Failed",d.result.msg||"Could not save data, unknown error.")}})}},onReset:function(){this.getForm().reset()},buttons:["reset","save"],saveButtonConfig:{iconCls:"icon-save",text:"Save",formBind:true},resetButtonConfig:{iconCls:"icon-reset",text:"Reset"},buildApiConfig:function(a,c){if(Bancha.getModel){return this.buildBanchaApiConfig(a,c)}else{if(c){return c}}var b=a.getProxy(),d=b&&b.api&&b.api.read?b.api.read:(b&&b.directFn?b.directFn:undefined);return d?{load:d}:undefined},buildBanchaApiConfig:function(b,c){c=c||{};var a=Ext.ClassManager.getName(b),e=a.substr(Bancha.modelNamespace.length+1),d=Bancha.getStubsNamespace()[e];return{load:c.read||d.read,submit:c.submit||d.submit}},buildButtonScope:(function(){var a={getPanel:function(){return this.panel||Ext.ComponentManager.get(this.id)},getForm:function(){return this.form||this.getPanel().getForm()}};return function(b){return Ext.apply({id:b},a)}}()),loadRecord:false,beforeBuild:function(c,b,a){},afterBuild:function(d,c,b,a){},buildConfig:function(d,c,b){var a=[],g,h,e,f;c=Ext.apply({},c,Ext.clone(this));b=b||{};c.target=Ext.isString(d)?d:Ext.ClassManager.getName(d);if(Ext.isString(d)){d=Ext.ModelManager.getModel(d)}if(!Ext.isArray(c.exclude)){c.exclude=[]}g=c.beforeBuild(d,c,b)||{};e=d.prototype.validations;d.prototype.fields.each(function(i){if(c.exclude.indexOf(i.name)===-1){a.push(Bancha.scaffold.Form.buildFieldConfig(i,d,c,e))}});Ext.each(a,function(i){if(i.xtype==="fileuploadfield"){g.isUpload=true;g.fileUpload=true;return false}return true});h=b.id||Ext.id(null,"formpanel-");g.id=h;c.buttons=Bancha.scaffold.Util.replaceButtonPlaceHolders(c.buttons||[],c,this.buildButtonScope(h));Ext.apply(g,b,{id:h,api:this.buildApiConfig(d,b.api),paramOrder:["data"],items:a,buttons:c.buttons});g.scaffold=c;if(Ext.isDefined(c.loadRecord)&&c.loadRecord!==false){f=function(j,i){j.load({params:{data:{data:{id:c.loadRecord}}}})};g.listeners=g.listeners||{};if(g.listeners.afterrender){g.listeners.afterrender=Ext.Function.createSequence(g.listeners.afterrender,f)}else{g.listeners.afterrender=f}}return c.afterBuild(g,d,c,b)||g}}});Ext.require(["Ext.form.Panel","Bancha.scaffold"],function(){Ext.apply(Ext.form.Panel,{scaffold:false});Ext.override(Ext.form.Panel,{initComponent:function(){if(Ext.isString(this.scaffold)){this.scaffold={target:this.scaffold}}if(Ext.isObject(this.scaffold)){var a=Bancha.scaffold.Form.buildConfig(this.scaffold.target,this.scaffold,this.initialConfig);Ext.apply(this,a);Ext.apply(this.initialConfig,a)}this.callOverridden()}})});Ext.require(["Ext.grid.Panel","Bancha.scaffold"],function(){Ext.apply(Ext.grid.Panel,{scaffold:false});Ext.override(Ext.grid.Panel,{initComponent:function(){if(Ext.isString(this.scaffold)){this.scaffold={target:this.scaffold}}if(Ext.isObject(this.scaffold)){var a=Bancha.scaffold.Grid.buildConfig(this.scaffold.target,this.scaffold,this.initialConfig);Ext.apply(this,a);Ext.apply(this.initialConfig,a)}this.callOverridden()}})});Ext.require(["Ext.grid.Panel","Bancha.scaffold"],function(){Ext.define("Bancha.grid.ManagementPanel",{extend:"Ext.tab.Panel",alias:"widget.managementpanel",models:[],panelDefaults:{},scaffoldDefaults:{},initComponent:function(){this.models=this.models||[];this.items=this.items||[];var a=this.items,b=this;Ext.each(this.models,function(e){var c=Ext.isString(e)?e:e.getName();e=Ext.ModelManager.getModel(c);if(!e&&Bancha.modelNamespace){e=Ext.ModelManager.getModel(Bancha.modelNamespace+"."+c)}var d={xtype:"gridpanel",title:Bancha.scaffold.Util.toTitle(Bancha.scaffold.Util.humanizeClassName(c)),scaffold:{target:c,buttons:false,deletable:true}};var f=e.getProxy();if(f.api){var g=["->"];if(f.api.create){g.push("create")}if(f.api.create||f.api.update){g.push("reset");g.push("save")}if(g.length>1){d.scaffold.buttons=g}else{d.scaffold.editable=false}if(!f.api.destroy){d.scaffold.deletable=false}}else{if(f.writer){delete d.scaffold.buttons}}d=Ext.apply(d,b.panelDefaults);d.scaffold=Ext.apply(d.scaffold,b.scaffoldDefaults);a.push(d)});this.callParent()}})});